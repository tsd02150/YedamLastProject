<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
	<meta charset="UTF-8">
	<style>
		.login {
			padding: 0;
		}

		.login-signup section-padding {
			padding-top: 0;
		}

		.py-20 {
			clear: both;
			height: 20px;
		}
		
		label{ display: inline-block; margin-right: 5px; }
	</style>
</head>

<body>
	<section class="login-signup section-padding" layout:fragment="content">
		<div class="container">
			<div class="row align-items-center justify-content-center">
				<div class="col-lg-7">
					<div class="findMyId">
						<div class="text-center">
							<h3>아이디 찾기</h3>
						</div>
						<div class="py-20"></div>
					</div>

					<form id="frm" action="findid" class="login-form row" method="post" onsubmit="validateForm()">
						<!-- th:onsubmit="validateForm()" -->
						<div class="col-md-12">
							<div class="form-group">
								<label for="mname">이름</label>
								<input type="text" id="mname" class="form-control" name="nm" placeholder="이름을 입력하세요" required>
								<span id="nameCheck"></span>
							</div>
						</div>
						<div class="col-md-12">
							<div class="form-group">
								<label for="telInput">연락처</label><br><input type="text" class="form-control" oninput="autoHyphen(this)"
									maxlength="13" name="to" id="telInput" placeholder="회원가입 시 입력한 전화번호를 입력하세요" style="width : 70%; display : inline;">
								<button type="button" id="codeBtn">인증번호 발송</button>
								<span id="telCheck"></span>
								<label for="codeCheckInput"></label>
								<input type="text" class="form-control" name="confirmcode" id="codeCheckInput" placeholder="인증번호를 입력하세요"style="width : 70%; display : inline;">
								<button type="button" id="codeCheckBtn">인증번호 확인</button><br>
								<span id="codeCheck"></span>
							</div>
						</div>
						<div class="col-md-12">
								<button class="btn btn-primary" type="submit">아이디찾기</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		
		<script>
		//연락처 저장 포맷 & 유효성검사
		 const autoHyphen = (target) => {
			    target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{3})(\d{4})(\d{4})$/, `$1-$2-$3`);
			};
			
			//이름 유효성 검사
			const nameInput = document.querySelector("#mname");
			const nameCheck = document.querySelector("#nameCheck");
			const telInput = document.querySelector("#telInput");

			nameInput.addEventListener("input", nameCheckFunc);
			
			function nameCheckFunc() {
			    const name = nameInput.value;

			    // Regular expression to validate Korean name
			    const nameRegex = /^[가-힣]{2,5}$/;

			    if (nameRegex.test(name)) {
			        nameCheck.textContent = "";
			    } else {
			        nameCheck.textContent = "잘못 입력하셨습니다.";
			    }
			};
			let smscode;
			//sms 인증번호 발송
			document.getElementById("codeBtn").addEventListener("click", function() {
			  if (nameInput.value == "") {
			    nameInput.focus();
			    return;
			  }
			  if (telInput.value == "") {
			    telInput.focus();
			    return;
			  }
			
			  let toUser = telInput.value.replace(/[^0-9]/g, '').replace(/^(\d{3})(\d{4})(\d{4})$/, '$1$2$3');
			  smscode = createSmsKey();
			  $.ajax({
			    url: "sendSms",
			    method: "POST",
			    data: {
			      to: toUser,
			      content: "[SMS] 인증번호 [" + smscode + "]를 입력해주세요"
			    },
			    success: function(response) {
			      console.log("key: " + smscode);
			      //checkCode(smscode);
						
			    },
			    error: function(err) {
			      console.log(err);
			    }
			  });
			});
			
			// 인증코드 6자리
			function createSmsKey() {
				  let key = '';
				  
				  for (let i = 0; i < 5; i++) { 
				    key += Math.floor(Math.random() * 10);
				  }
				  return key;
				}
			
			let clickCount = 0; //클릭 횟수 제한
			
			// sms 인증번호 확인.
			document.getElementById("codeCheckBtn").addEventListener("click", checkCode(smscode));
			
			function checkCode(codesms){
				console.log(telInput.value);
				console.log(codesms);
				
				if(telInput.value !== codesms){
					clickCount++;
					$("#codeCheck").text("인증번호를 다시 입력하세요");
					$("#codeCheck").css({
						"color": "#FA3E3E",
						"font-weight": "bold",
						"font-size": "14px"
					});
				} else{
					$("#codeCheck").text("인증이 완료되었습니다.");
					$("#codeCheck").css({
						"color": "#0D6EFD",
						"font-weight": "bold",
						"font-size": "14px"
					});
				}
				
				if (clickCount >= 5) {
		      alert("5회 이상 실패하셨습니다.\n본인인증을 다시 진행해주세요.");
		      window.location.reload();
				}
			}
			
			function validateForm() {
				event.preventDefault();

				let telCheckUrl = "/member/getMember?tel=" + encodeURI(telInput.value) + "&nm=" + encodeURI(nameInput.value);

			    $.ajax({
			        url: telCheckUrl,
			        method: "GET",
			        success: function(result) {
			        	console.log(result);
			            if(result == null){ //가입정보가 없으면.
			            	alert("가입 정보가 없습니다.");
			            } else {
			            	$.ajax({
											type: "POST",
											url: "/member/findIdSuccess",
											data: {
												"id": result.id
											},
											success: function (data) {
												console.log("아이디: " + data.id);
												
												// 아이디찾기 완료 페이지 호출
												document.getElementById('frm').submit();
											}
										});
			            }
			        },
			        error: function(err) {
			            console.log(err);
			        }
			    });
		}
		</script>

	</section>
</body>

</html>