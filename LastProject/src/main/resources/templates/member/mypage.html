<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout2}">

<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>

#mypagetbl, #intrestTbl, #myordertbl{
	border: 1px solid #DDDDDD;
	height: auto;
}


#mypagetbl, #intrestTbl, #myordertbl {
	width: 700px;
	font-size: larger;
}

#mypagetbl th, .intehead, #myordertbl th {
	padding: 20px;
	width: 520px;
}

#mypagetbl td, #intrestTbl td, #myordertbl td {
	text-align: right;
	padding-right: 20px;
	width: 200px;
}

.titleTxt {
	text-align: center;
}

.py-20 {
	clear: both;
	height: 20px;
}

.bi {
	font-size: 50px;
	margin-top: 15px;
}

.int_item {
	width: 130px;
	height: 120px;
	border: 1px solid #dddddd;
	display: inline-block;
	padding: 15px;
	margin: 15px;
}

.itembox {
	text-align: left;
	padding: 10px;
	width: 611px;
}

.rate, .tprc {
	font-size: 16px;
	font-weight: bold;
}

.tnm {
	font-size: 20px;
}


.orderDiv {
	width: 200px;
	height: 200px;
	border: 1px solid #dddddd;
	display: inline-block;
	padding: 15px;
	margin: 15px;
}
.interestSection{
height: 200px;
}
#thisbox{
	height: 300px;
}
#thisbox button{
	margin-left : 250px;
	margin-top : 20px;
	text-align: center;
}
#thisbox2 button{
	margin-left : 260px;
	margin-top : 20px;
	margin-bottom : 50px;
	text-align: center;
}
#orderBox button{
	margin-left : 250px;
	margin-top : 20px;
	text-align: center;
}
.nostock{
	text-align: center;
	margin-top : 50px;
	font-size: larger;
	font-weight: bold;
}
</style>
</head>
<body>
<div layout:fragment="mypage">
		<!-- 내프로필 -->
			<div id="mypageBody">
				<table id="mypagetbl">
					<tr class="itemhead" style="background-color : bisque">
						<th>내 프로필</th>
						<td>
						<!-- 일반로그인이면 비밀번호 확인 후 페이지로 이동 -->
			        <a th:if="${session.loggedInMember.path == null}" th:href="@{/member/mypageIntro}">
			            <p class="bi bi-arrow-right-square-fill"></p>
			        </a>
			        <!-- 소셜로그인이면 바로 회원정보 수정으로 이동 -->
			        <a th:if="${session.loggedInMember.path != null}" th:href="@{/member/mypageInfo}">
			            <p class="bi bi-arrow-right-square-fill"></p>
			        </a>
				    </td>
					</tr>
					<tr>
						<th>[[${session.loggedInMember.nm}]]</th>
						<td></td>
					</tr>
					<tr>
						<th>[[${session.loggedInMember.tel}]]</th>
						<td></td>
					</tr>
					<tr>
						<th th:text="${#numbers.formatInteger(session.loggedInMember.point, 0, 'COMMA')}"></th>
						<td><a href="pointChargeForm"><button type="button" class="btn btn-outline-secondary">충전</button></a></td>
					</tr>
				</table>
			</div>
			<div class="py-20"></div>
			<!-- interest item -->
			<div id="intrest">
			<table id="intrestTbl">
					<tr style="background-color : bisque">
						<th class="intehead">주식현황</th>
						<td><a href="mystock"><p class="bi bi-arrow-right-square-fill"></p></a></td>
					</tr>
					<tr>
						<th colspan="2" class="itembox">
							<div id="thisbox"></div>
						</th>
					</tr>
				</table>
				<div class="py-20"></div>
				<div class="interestSection">
				<h4 style="padding-left : 25px;">+ 관심종목</h4>
				<div id="thisbox2">
				</div>
				</div>
			</div>
			<!-- interest item end -->
		<!-- order -->
			<table id="myordertbl">
			  <tr class="itemhead" style="background-color : bisque">
			    <th>주문 : 배송</th>
			    <td><a href="myorder"><p class="bi bi-arrow-right-square-fill"></p></a></td>
			  </tr>
			  <tr>
			    <th colspan="2" style="padding-bottom: 0px;">결제내역</th>
	 			</tr>
			  <tr>
			    <th id="orderBox" colspan="2" style="padding-top: 0px;"></th>
	 			</tr>
			</table>
			<!-- order end -->
			
		<!-- 내프로필 end -->
	<!-- 	<img th:src=${rice.png}> -->
		<!-- 관심종목 -->
		<div class="col-lg-7 col-md-12 col-sm-12 col-xs-12">
			
		</div>
		<!-- 관심종목 end -->
<script>
let id = "[[${session.loggedInMember.id}]]";
let membNo = "[[${session.loggedInMember.membNo}]]";

let box = '';
let box2 = '';
let prd = '';
let img='';

//보유주식 리스트 출력
$.ajax({
	url : "myPossStockList",
	method : "POST",
	data : {
		"membNo" : membNo
	},
	success : function(data){
		console.log(data)
		if(data && data.length >0){
			
		//보유주식 최대 8개까지만 출력(rate 기준 정렬)  stock/chart?itemNo=ite-1
		data.slice(0, 8).forEach(el => {
			//console.log(el);
		let tprc = commas(el.nowPrc); 
		let rate = commas(el.rate); 
		  box += `<div class="int_item">
		            <a onclick="location.href='/stock/chart?itemNo=${el.itemNo}'"><p class="tnm">${el.tnm}</p></a>
		            <span class="rate">${rate}</span><br>
								<span class="tprc">${tprc} P</span>
		          </div>`;
		});
		 
		$("#thisbox").html(box);
		boxClass();
		}else{
			let p = `
				<p class="bi bi-exclamation-circle" style="text-align: center; font-size: 40pt; margin-top:40px;"></p>
				<p class="nostock">보유한 종목이 없습니다.</p>
				<a onclick="location.href='/stock/itemListPage'"><button class="btn btn-primary">주식페이지로 이동</button></a>
			`;
			$("#thisbox").html(p);
		}
	},
	error : function(err){
		console.log(err)
	}
});
	
//관심종목 리스트 출력
	$.ajax({
		url : "interestList",
		method : "POST",
		data : {
			"membNo" : membNo
		},
		success : function(data){
			//보유주식 최대 4개까지만 출력(rate 기준 정렬)
			if(data && data.length >0){
			data.slice(0, 4).forEach(el=>{
				let tprc = commas(el.tprc); 
				//console.log(el);
				box2 += `<div class="int_item">
									<p onclick="location.href='/stock/chart?itemNo=${el.itemNo}'" class="tnm">${el.tnm}</p>
									<span class="rate">${el.rate}</span><br>
									<span class="tprc">${tprc} P</span>
				 					</div>`;
			})
			
			$("#thisbox2").html(box2);
			boxClass();
			}else{
				
				box2 += `
					<p class="nostock">관심 종목이 없습니다.</p>
				<a onclick="location.href='/stock/itemListPage'"><button class="btn btn-primary">주식페이지로 이동</button></a>`;
				$("#thisbox2").html(box2);
			}
		},
		error : function(err){
			console.log(err)
		}
	});
	
	function boxClass() {
		  $(".rate").each(function() {
		    var rate = parseInt($(this).text());
		    if (rate >= 0) {
		      $(this).addClass("high");
		    } else {
		      $(this).addClass("low");
		    }
		  });
		}
	
	// 결제내역 : 배송완료 주문 리스트 출력
	$.ajax({
	  url: "mypageOrderList",
	  method: "POST",
	  data: {
	    "id": id,
	    "orderSt": "배송완료"
	  },
	  success: function(data) {
		  if(data && data.length >0){
	      data.slice(0, 3).forEach(function(el) { //3개만 출력
	        //console.log(el);
	        let orderDt = new Date(el.orderDt); // 날짜 객체 생성
	        let formattedDt = `${orderDt.getFullYear()}-${(orderDt.getMonth() + 1).toString().padStart(2, '0')}-${orderDt.getDate().toString().padStart(2, '0')}`;
	        var orderAm = commas(el.orderAm); 
	        prd += `
	          <div class="orderDiv">
	            <p class="orderDt">${formattedDt}</p>
	            <p class="prdtimg" data-no="${el.prdtNo}"></p>
	            <p class="prdtnm" data-no="${el.prdtNo}"></p>
	            <p class="orderAm">${orderAm}</p>
	          </div>`;
	      });

	      // 상품 리스트 출력(prde_no, 상품명, 이미지)
	      //<img 	th:src="|/mall/images/main/${prdt.thumb}|">
	      $.ajax({
	        url: "mypagePrdtList",
	        success: function(data) {
	          data.forEach(function(res) {
	            //console.log(res);
	            //img += `<img th:src="/mall/images/main/res.img"`;
	            $(".prdtimg[data-no='" + res.prdtNo + "']").html(res.img);
	            $(".prdtnm[data-no='" + res.prdtNo + "']").append(res.nm);
	          });
	        },
	        error: function(err) {
	          console.log(err);
	        }
	      });

	      $("#orderBox").html(prd);
	    } else {
	    	let p =`
		    	<p class="nostock">결제내역이 없습니다.</p>
					<a onclick="location.href='/mall/mallMain'"><button class="btn btn-primary">포인트몰로 이동</button></a>
          `;
	    	 $("#orderBox").html(p);
	    }
	  },
	  error: function(err) {
	    console.log(err);
	  }
	});
	
	//천단위 콤마
	function commas(number) {
	  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
	}
</script>
</div>
</body>

</html>