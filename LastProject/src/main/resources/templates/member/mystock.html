<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout2}">

<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
#sum {
	border: 1px solid #DDDDDD;
	height: auto;
	height: 150px;
}
#ownList {
	border: 1px solid #DDDDDD;
	height: auto;
}
#gotoInfo{
	height: 80px;
	background-color: bisque;
	margin:auto;
}
#gotoInfo h3{
	padding-top : 25px;
	display : inline-block;
}
.bi.bi-arrow-right-square-fill{
	display : inline-block;
	float : right;
}
#mystockDiv{
	border: 1px solid #DDDDDD;
	height: 500px;
	margin-top : 20px;
	display : inline-block;
	overflow: auto;
}
#myorderDiv{
	border: 1px solid #DDDDDD;
	height: 500px;
	margin-top : 20px;
	margin-left : 10px;
	display : inline-block;
	width : 200px;
	overflow: auto;
}
#buysellList{
	border: 1px solid #DDDDDD;
	height: 460px;
	margin-top : 20px;
	padding : 10px;
}
#interestDiv, #recomDiv{
	display : inline-block;
	border: 1px solid #DDDDDD;
	height: 310px;
	margin-left : 40px;
	margin-top : 20px;
	overflow: auto;
}
#interesttbl{
	width : 100%;
	
}

#interestDiv button, #recomDiv button{
 margin-left:30px;
 margin-top:80px;
}
#sum table td{
	font-size : 25px;
	padding : 20px;
	padding : 20px;
	font-weight: bold;
	text-align : right;
}
#sum table th{
	font-size : 14px;
	text-align : left;
}
#buyselltbl{
	text-align: center;
}
#ownList table{
	text-align : center;
}
#ownList table td{
	text-align : center;
	width : 110px;
	font-size : 20px;
	padding : 5px;
	font-weight: bold;
	padding-top : 20px;
}
#noOrderDiv{
	text-align: center;
	margin-top : 180px;
}
#noOrderTxt{
 font-weight: bold;
}
#intbody tr{ /* :nth-chid(1) */
	text-align : left;
}

</style>
</head>
<body>
<div layout:fragment="mypage">
		<div id="mypageBody" class="z-flex">
			<div id="gotoInfo" class="col-12">
				<h3>주식현황</h3>
				<a href="mystockInfo"><p class="bi bi-arrow-right-square-fill"></p></a>
			</div>
			<div class="col-12" style="margin : auto;">
				<div id="mystockDiv" class="col-7">
					<div id="sum" class="col-12">
					</div>
					<div id="ownList" class="col-12"></div>
				</div>
				<div id="myorderDiv">
					<div id="noOrderDiv" th:style="${#lists.isEmpty(sellOrderList) && #lists.isEmpty(buyOrderList) ? '' : 'display : none'}">
						<p id="noOrderTxt">주문 내역이 없습니다.<p>
						<a onclick="location.href='/stock/itemListPage'"><button class="btn btn-primary">주식페이지로 이동</button></a>
					</div>
					<div id="buyOrder"></div>
					<div id="sellOrder"></div>
				</div>
			</div>
			<div id="buysellList" class="col-12">
			<h3>거래내역</h3>
			<input type="date" id="dstart"> ~ 
			<input type="date" id="dend">
			<button type="button" id="oneMonthBtn">1개월</button>
			<button type="button" id="threeMonthsBtn">3개월</button>
			<button type="button" id="sixMonthsBtn">6개월</button>
			<select id="buysellsel">
				<option value="">전체거래</option>
				<option value="B">매수</option>
				<option value="S">매도</option>
			</select>
				<table id="buyselltbl" class="col-12">
					<thead>
						<tr>
							<th>체결날짜</th>
							<th>구분</th>
							<th>종목</th>
							<th>가격</th>
							<th>수량</th>
							<th>수수료</th>
							<th>합계</th>
						</tr>
					</thead>
					<tbody id="buysellbody">
					</tbody>
				</table>
				<div>
					<nav aria-label="Page navigation example" class="d-flex justify-content-center">
						<ul class="pagination">
							<li class="page-item">
								<a class="page-link" id="firstpage" href="javascript:firstPage()" aria-label="Previous">
									<span aria-hidden="true">&laquo;</span>
								</a>
							</li>
							<li class="page-item">
								<a class="page-link" id="prevpage" href="javascript:prevPage()" aria-label="Previous">
									<span aria-hidden="true" style="visibility: hidden;">&lt;</span>
								</a>
							</li>
							<!-- 페이징버튼 들어갈 공간 -->
							    <li class="page-item">
									<a class="page-link" id="nextpage" href="javascript:nextPage()" aria-label="Next">
										<span aria-hidden="true" style="visibility: hidden;">&rt;</span>
									</a>
								</li>
							    <li class="page-item">
									<a class="page-link" id="lastpage" href="javascript:lastPage()" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
									</a>
								</li>
							</ul>
						</nav>
					</div>
			</div>
			<div class="col-12">
				<div id="interestDiv" class="col-5">
					<table id="interesttbl">
						<thead>
							<tr>
							<th>관심종목</th>
							<th></th>
							<th></th>
							<th></th>
							</tr>
						</thead>
						<tbody id="intbody"></tbody>
					</table>
				</div>
				<div id="recomDiv" class="col-5">
					<table id="recomtbl" class="col-12">
						<thead>
							<tr>
							<th>추천종목</th>
							<th></th>
							<th></th>
							<th></th>
							</tr>
						</thead>
						<tbody id="recombody">
						</tbody>
					</table>
				</div>
			</div>
		</div>

		
	<script>
 	const memNo = "[[${session.loggedInMember.membNo}]]";
 	const dt = "[[${#dates.format(session.loggedInMember.joinDt, 'yyyy/MM/dd')}]]";
 	let dtFormat = "[[${#dates.format(session.loggedInMember.joinDt, 'yyyy-MM-dd')}]]";
	let div1='';
	let div2='';
 	let kind = "";
 	let startDate = dt;
 	let today = new Date();   
 	let year = today.getFullYear(); // 년도
 	let month = today.getMonth() + 1 <10 ? '0'+(today.getMonth() + 1) : today.getMonth() + 1;  // 월
 	let date = today.getDate() < 10 ? date = '0'+today.getDate() : today.getDate();  // 날짜
 	let endDate = year + '/' + month + '/' + date ; 
 	
 	$("#dstart").val(dtFormat);
 	$("#dend").val(`${year}-${month}-${date}`);
 	
 	let targetPage = 1;
 	let startPage=1;
 	let endPage=10;
 	let totalCnt;
 	
 	//매도 매수 거래내역 호출
 	buysell(); 
 	pageBtn();
 	
 	$("#buysellsel").on("change",function(){
 		$("#buysellbody").html("");
 		kind = $("#buysellsel option:selected").val();
    startDate = $("#dstart").val();
    endDate = $("#dend").val();
    buysell();
	 	pageBtn();
 	})
 	
//매도 매수 거래내역
 	function buysell(){
	$.ajax({
		url : "buysellList",
		method : "POST",
		data : {
			"membNo" : memNo,
      "kind": kind,
      "startDate" : $("#dstart").val(),
      "endDate" : $("#dend").val(),
      "page" : targetPage
		},
		success : function(data){
			let tr='';
			data.forEach(el=>{
			let taPrc = commas(el.taPrc);
				let orderDt = new Date(el.taDt);
        let formattedDt = `${orderDt.getFullYear()}-${(orderDt.getMonth() + 1).toString().padStart(2, '0')}-${orderDt.getDate().toString().padStart(2, '0')}`;
				console.log(el);
				tr += `
					<tr>
					<td>${formattedDt}</td>`;
				if(el.kind === 'B'){
					tr += `<td class="high">매수</td>`;
				}else{
					tr += `<td class="low">매도</td>`;
				}
				
				tr += `
					<td>${el.tnm}</td>
					<td>${taPrc}</td>
					<td>${el.stockCnt}</td>
					<td>${(el.stockCnt*el.taPrc)*0.1}</td>
					<td>${(el.stockCnt*el.taPrc-((el.stockCnt*el.taPrc)*0.1))}</td>
				</tr>
				`;
			});
			$("#buysellbody").html(tr);
		}, error : function(err){
			console.log(err);
		}
	});
}
 	
	//매수 주문 현황
	 $.ajax({
		 url : "buyOrderList",
		 method : "POST",
		 data : {
			 "membNo" : memNo
		 },
		 success : function(data){
			 if(data && data.length >0){
				 $("#noOrderDiv").css("dispaly","none");
			 data.forEach(el=>{
				 let prc = (el.prc).toLocaleString();
				 if(el.rmnCnt >0){
					 div1 +=`
					 				<div data-no="${el.buyNo}" style="text-align:center; border: 1px solid #DDDDDD;">
					 					<span style="font-weight : bold;">매수 주문 예약</span>
					 					<span style="color:red;font-size:20px;" onclick="delBuyOrder(this)">&times&nbsp</span>
					 					<table style="width : 100%;">
					 						<tr>
					 							<th>종목명</th>
					 							<td>${el.nm}</td>
					 						</tr>
					 						<tr>
					 							<th>주문수량</th>
					 							<td>${el.rmnCnt} 개</td>
					 						</tr>
					 						<tr>
					 							<th>주문가격</th>
					 							<td>${prc} point </td>
					 						</tr>
					 					</table>
					 				</div>
					 `; 
				 }else{
					 $("#noOrderDiv").css("dispaly","inline-block");
				 }
			 })
			 }else{
				 $("#noOrderDiv").css("dispaly","block");
			 }
			 $("#buyOrder").html(div1);
		 },
		 error : function(err){
			 console.log(err);
		 }
	 });
	
	//매도 주문 현황
	 $.ajax({
		 url : "sellOrderList",
		 method : "POST",
		 data : {
			 "membNo" : memNo
		 },
		 success : function(data){
			 if(data && data.length >0){
			 data.forEach(el=>{
				 if(el.rmnCnt >0){
				 div2 +=`
		 				<div data-no="${el.sellNo}" style="text-align:center; border: 1px solid #DDDDDD;">
		 					<span style="font-weight : bold;">매도 주문 예약</span>
		 					<span style="color:red;font-size:20px;" onclick="delSellOrder(this)">&times&nbsp</span>
		 					<table style="width : 100%;">
		 						<tr>
		 							<th>종목명</th>
		 							<td>${el.nm}</td>
		 						</tr>
		 						<tr>
		 							<th>주문수량</th>
		 							<td>${el.rmnCnt}</td>
		 						</tr>
		 						<tr>
		 							<th>주문가격</th>
		 							<td>${el.prc}</td>
		 						</tr>
		 					</table>
		 				</div>
					 `; 
				 }else{
					 
				 }
			 })
			 }else{
				 $("#noOrderDiv").css("dispaly","block");
			 }
			 $("#sellOrder").html(div2);
		 },
		 error : function(err){
			 console.log(err);
		 }
	 });
	
	//매수 주문 예약 삭제
 function delBuyOrder(target) {
	  let dataNo = target.parentNode.getAttribute('data-no');
	  //console.log(dataNo);
	  $.ajax({
		  url : "deleteBuyOrder",
		  method : "POST",
		  data : {
			  "membNo" : memNo,
			  "buyNo" : dataNo
		  },
		  success : function(res){
			  console.log(res);
			  $(target).parent().remove();
			  toastShow("Delete","매수 주문 예약이 삭제되었습니다.","success");
			  window.location.reload();
		  },
		  error : function(err){
			  console.log(err);
		  }
	  });
	}
	//매도 주문 예약 삭제
 function delSellOrder(target) {
	  let dataNo = target.parentNode.getAttribute('data-no');
	  //console.log(dataNo);
	  $.ajax({
		  url : "deleteSellOrder",
		  method : "POST",
		  data : {
			  "membNo" : memNo,
			  "sellNo" : dataNo
		  },
		  success : function(res){
			  console.log(res);
			  $(target).parent().remove();
			  toastShow("Delete","매도 주문 예약이 삭제되었습니다.","success");
			  window.location.reload();
		  },
		  error : function(err){
			  console.log(err);
		  }
	  });
	}

//관심종목 리스트
 let tr1 = '';
 let tr2 = '';
	// 숫자를 콤마로 포맷하는 함수
	function formatNumber(number) {
	  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}	

 // 관심종목 리스트 출력
 $.ajax({
   url: "interestList",
   method: "POST",
   data: {
     "membNo": memNo
   },
   success: function(data) {
	   if(data && data.length >0){

    	 data.forEach(el => {
         let itemNo = el.itemNo;
         //console.log(el);
         tr1 += `
           <tr data-no="${el.itemNo}">
             <td onclick="location.href='/stock/chart?itemNo=${el.itemNo}'">${el.tnm}</td>
             <td>${formatNumber(el.tprc)}</td>
             <td class="rate">${el.rate}%</td>
             <td><span style="color:red;font-size:20px;" onclick="deleteInterest('${el.itemNo}')">&times&nbsp</span></td>
           </tr>
         `;
       });
     } else {
    	 tr1 += `<a onclick="location.href='/stock/itemListPage'"><button class="btn btn-primary">주식페이지로 이동</button></a>`;
     }

     // 출력된 관심종목 리스트를 HTML에 추가합니다.
     $("#intbody").html(tr1);
     boxClass();
   },
   error: function(err) {
     console.log(err);
   }
 });
	
	function boxClass() {
		  $(".rate").each(function() {
		    var rate = parseInt($(this).text());
		    if (rate >= 0) {
		      $(this).addClass("high");
		    } else {
		      $(this).addClass("low");
		    }
		  });
		}
	
	//관심종목 삭제
function deleteInterest(itemNo) {
  $.ajax({
    url: "deleteInterest",
    method: "POST",
    data: {
      "itemNo": itemNo,
      "membNo": memNo
    },
    success: function(result) {
      if (result == 1) {
        // 삭제된 항목을 테이블에서 제거합니다.
        $(`tr[data-no='${itemNo}']`).remove();
        toastShow("Delete", "관심종목이 삭제되었습니다.", "success");
      }
    },
    error: function(err) {

    }
  });
}

//보유자산 리스트 출력
$.ajax({
	  url: "myPossStockList",
	  method: "POST",
	  data: {
	    "membNo": memNo
	  },
	  success: function(data) {
		  //console.log(data);
		  let asset = 0;
		  let invest = 0;

		  data.forEach(el => {
			  let formattedRaise = (el.tradePrc - el.nowPrc).toLocaleString();
		    let tr = `
		    	<table class="col-12">
		      <tr data-no="${el.itemNo}">
		        <td onclick="location.href='/stock/chart?itemNo=${el.itemNo}'">${el.tnm}</td>
		        <td class="rate">${formattedRaise}</td>
		        <td class="rate">${el.rate}%</td>
		      </tr>
		      </table>
		    `;

		    asset += el.tradePrc;
		    invest += el.nowPrc;
		    
		    $("#ownList").append(tr);
		    boxClass();
		  });
		  
		  let formattedAsset = (asset * 10).toLocaleString();
		  let formattedInvest = (invest * 10).toLocaleString();
		  
		  let tr2 = `
		    <table class="col-12">
		      <tr>
		        <th>자산(평가금액)</th>
		        <td>${formattedAsset}원</td>
		      </tr>
		      <tr>
		        <th>투자금액</th>
		        <td>${formattedInvest}원</td>
		      </tr>
		    </table>
		  `;

		  $("#sum").append(tr2);
		},
	  error: function(err) {
	    console.log(err);
	  }
	});
	
	let tr3='';
	//추천종목 리스트 출력
	$.ajax({
		url : "recomList",
		method : "POST",
		data : {
			"membNo" : memNo
		},
		success : function(data){
			if(data && data.length >0){
				data.slice(0, 10).forEach(el => {
					console.log(el);
	         tr3 += `
	           <tr data-no="${el.itemNo}">
	             <td onclick="location.href='/stock/chart?itemNo=${el.itemNo}'">${el.tnm}</td>
	             <td>${formatNumber(el.tprc)}</td>
	             <td class="rate" colspan="2">${el.rate}%</td>
	           </tr>
	         `;
	       });
				$("#recombody").html(tr3);
				   boxClass();
			}else{
				console.log("랜덤")
				$.ajax({
				    url: "myItemCheck",
				    success: function (data) {
			        // 데이터를 랜덤하게 섞음
			        let randomData = randomArray(data);

			        // 랜덤하게 섞인 데이터에서 처음 25개만 선택
			        let selectedData = randomData.slice(0, 25);

			        selectedData.slice(0,10).forEach(function (el) {
			        	console.log(el);
			        	tr3 += `<tr data-no="${el.itemNo}">
				             <td onclick="location.href='/stock/chart?itemNo=${el.itemNo}'">${el.nm}</td>
				             <td>${formatNumber(el.tprc)}</td>
				             <td class="rate" colspan="2">${el.change}%</td>
				           </tr>`;
			        })
			        $("#recombody").html(tr3);
					   	boxClass();
				    }
				})
			}
		},
		error : function(err){
			console.log(err);
		}
	});
	
	// 배열을 랜덤하게 섞는 함수
  function randomArray(array) {
    let currentIndex = array.length;
    let temporaryValue, randomIndex;

    while (0 !== currentIndex) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
    }
    return array;
  }


//1개월, 3개월, 6개월 클릭
function updateStartDate(period) {
    let today = new Date();
    let startDate = new Date();

    switch (period) {
      case "oneMonth":
        startDate.setMonth(startDate.getMonth() - 1);
        break;
      case "threeMonths":
        startDate.setMonth(startDate.getMonth() - 3);
        break;
      case "sixMonths":
        startDate.setMonth(startDate.getMonth() - 6);
        break;
      default:
        break;
    }

    let startYear = startDate.getFullYear();
    let startMonth = startDate.getMonth() + 1 < 10 ? "0" + (startDate.getMonth() + 1) : startDate.getMonth() + 1;
    let startDateStr = startYear + "-" + startMonth + "-" + startDate.getDate();
    
    $("#dstart").val(startDateStr);
  }

  $("#oneMonthBtn").on("click", function() {
    updateStartDate("oneMonth");
    buysell();
    pageBtn();
  });

  $("#threeMonthsBtn").on("click", function() {
    updateStartDate("threeMonths");
    buysell();
    pageBtn();
  });

  $("#sixMonthsBtn").on("click", function() {
    updateStartDate("sixMonths");
    buysell();
    pageBtn();
  });
  
  function pageBtn() {
	    $.ajax({
	        url: "buysellCount",
	        method: "POST",
	        data: {
	        	"membNo" : memNo,
            "kind": kind,
            "startDate" : $("#dstart").val(),
            "endDate" : $("#dend").val()
	        },
	        success: function (data) {
	            $('#nextpage').css('visibility', 'hidden');
	            $('#prevpage').css('visibility', 'hidden');
	            totalCnt = data;
	            endPage=~~((totalCnt-1)/10 + 1);
	            createPageCntBtn(startPage, endPage);
	            if(totalCnt>100){
	            	$('#nextpage').css('visibility', 'hidden');
		            $('#prevpage').css('visibility', 'hidden');
							}
	        },
	        error: function (err) {
	            console.log(err);
	        }
	       });
	   }
	   
	   //페이지 버튼생성
	   function createPageCntBtn(start,end){
	      $('.pagebtn').remove();
	      
	      for (let i = start; i <= end; i++) {
	        let liTag = $('<li></li>').addClass('page-item').addClass('pagebtn');
	        if (i % 10 === targetPage) {
	          liTag.addClass('active');
	        }
	        let aTag = $('<a></a>').addClass('page-li	nk').attr('href', 'javascript:pageMove(' + i + ');').text(i);
	        liTag.append(aTag);
	        $('#nextpage').before(liTag);
	      }
	   }
	   
	   //페이징 버튼클릭
	   function pageMove(page) {
		   $("#dealbody").html("");
		  $('.pagebtn.active').removeClass('active');
		  console.log(page);
		  targetPage = page;
		  buysell();
		  $('.pagebtn').each(function () {
		    if ($(this).children('a').text() == page) {
		      $(this).addClass('active');
		       }
		     });
	   }
	      
	   // 페이징 < 버튼 클릭
	   function prevPage() {
		   $("#dealbody").html("");
	     $('#nextpage').css('visibility', 'visible');
	     startPage -= 10;
	     endPage -= 10;
	     if (startPage === 1) {
	       $('#prevpage').css('visibility', 'hidden');
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   // 페이징 > 버튼 클릭
	   function nextPage() {
		   $("#dealbody").html("");
	     $('#prevpage').css('visibility', 'visible');
	     startPage += 10;
	     endPage += 10;
	     if (endPage >= ~~((totalCnt - 1) / 10 + 1)) {
	       endPage = ~~((totalCnt - 1) / 10 + 1);
	       $('#nextpage').css('visibility', 'hidden');
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   function firstPage() {
		   $("#dealbody").html("");
	     startPage = 1;
	     if (endPage > 10) {
	       endPage = 10;
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   function lastPage() {
		   $("#dealbody").html("");
	     if (endPage > 10) {
	       endPage = ~~((totalCnt - 1) / 10 + 1);
	     }
	     startPage = endPage - endPage % 10 + 1;
	     //console.log(startPage, endPage);
	     createPageCntBtn(startPage, endPage);
	     pageMove(endPage);
	   }
   function commas(number) {
	   return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
	 }
	</script>
</div>
</body>

</html>