<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout2}">

<head>
<meta charset="UTF-8">
<title>회원관리</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
.sidebar.sidebar-left {
	height: 1000px;
}

.titleMenu {
	padding-top: 20px;
}

.sidebarMenu {
	padding-top: 40px;
	padding-bottom: 40px;
}

#mypageBody, .sidebar {
	border: 1px solid #DDDDDD;
	height: auto;
}
#myPointList, #myCouponList{
	text-align: left;
	margin-top : 50px;
	margin-left : 60px;
}
#myCouponList{
	margin-bottom : 50px;
}
#chargeBtn{
font-size:40px; padding-left:30px; font-weight:bold;
color: green;
}
#myPointTblDiv{
border: 1px solid #DDDDDD;
width: 700px;
margin : auto;
}
#myPointTbl{
	width: 100%;
	text-align : center;
}

#dealSel{
	float : right;
	margin-right : 20px;
}
</style>
</head>
<body>
<div layout:fragment="mypage">
	<div id="mypageBody">
	<div id="myPointList">
		<span>로고</span>
		<span style="font-size:40px; color:black;">My 포인트</span>
		<strong> <span th:text="|${#numbers.formatInteger(mypoint, 0, 'COMMA')}|" style="font-size:40px; padding-left:30px; color:black;"></span></strong>
		<span style="font-size:30px; color:black;"> point</span>
		<a href="pointChargeForm" id="chargeBtn" >충전</a><br>
	</div>
	<div id="myCouponList">
		<span>로고</span>
		<span style="font-size:40px; color:black;">My 쿠폰</span>
		<strong> <span th:text="${#lists.size(mycoupon)}" style="font-size:40px; padding-left:70px; color:black;"></span></strong>
		<span style="font-size:30px; color:black;"> 개</span>
	</div>
	<div id="myPointTblDiv">
		<h4>포인트 적립 | 사용 내역</h4>
		<input type="date" id="startDate">
		<input type="date" id="endDate">
		<select id="dealSel">
    <option value="">전체거래</option>
    <option value="매도">매도</option>
    <option value="매수">매수</option>
    <option value="충전">충전</option>
    <option value="포인트몰">포인트몰</option>
</select>
<table id="myPointTbl">
    <thead>
        <tr>
            <th>날짜</th>
            <th>구분</th>
            <th>종목or제품이름</th>
            <th>이용내역</th>
        </tr>
    </thead>
    <tbody id="dealbody">

    </tbody>
</table>
</div>
</div>

<script>
const membNo = "[[${session.loggedInMember.membNo}]]";
const dt = "[[${session.loggedInMember.joinDt}]]";

let tablename = "";

//startDate: 가입날짜 
//endDate : 오늘 날짜
let startDate = dt;
let today = new Date();   
let year = today.getFullYear(); // 년도
let month = today.getMonth() + 1 <10 ? '0'+(today.getMonth() + 1) : today.getMonth() + 1;  // 월
let date = today.getDate() < 10 ? date = '0'+today.getDate() : today.getDate();  // 날짜

let endDate = year + '/' + month + '/' + date; 
$("#startDate").val(startDate);
$("#endDate").val(`${year}-${month}-${date}`);


dealList();

// 거래내역 호출
function dealList() {
    $.ajax({
        url: "dealList",
        method: "POST",
        data: {
            "membNo": membNo,
            "tablename": tablename,
            "startDate" : startDate,
            "endDate" : endDate
        },
        success: function (data) {
            let tr = ''; // 각 호출마다 tr을 초기화
            data.forEach(el => {
            let point = commas(el.point);
            	let orderDt = new Date(el.orderDt);
            	let formattedDt = `${orderDt.getFullYear()}-${(orderDt.getMonth() + 1).toString().padStart(2, '0')}-${orderDt.getDate().toString().padStart(2, '0')}`;
                tr += `
                        <tr>
                            <td>${formattedDt}</td>
                            <td>${el.tablename}</td>`;
                if (el.nm == null) {
                    tr += `<td>적립</td>`;
                } else {
                    tr += `<td>${el.nm}</td>`;
                }
                tr += `
                            <td>${point}</td>
                        </tr>
                `;
            });
            $("#dealbody").html(tr);
        },
        error: function (err) {
            console.log(err);
        }
    });
	}

	$("#dealSel").on("change", function () {
	    $("#dealbody").html(""); // select가 변경되면 이전에 출력한 내용 초기화
	    tablename = $("#dealSel option:selected").val();
	    startDate = $("#startDate").val();
	    endDate = $("#endDate").val();
	    dealList();
	});
	
	function commas(number) {
		  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
		}
</script>
</div>
</body>

</html>