<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout2}">

<head>
<meta charset="UTF-8">
<title>회원관리</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>

#mypageBody{
	border: 1px solid #DDDDDD;
	height: auto;
}
#myPointList, #myCouponList{
	text-align: left;
	margin-top : 50px;
	margin-left : 60px;
}
#myCouponList{
	margin-bottom : 50px;
}
#chargeBtn{
font-size:40px; padding-left:30px; font-weight:bold;
color: green;
}
#myPointTblDiv{
border: 1px solid #DDDDDD;
width: 700px;
margin : auto;
}
#myPointTbl{
	width: 100%;
	text-align : center;
}

#dealSel{
	float : right;
	margin-right : 20px;
}
</style>
</head>
<body>
<div layout:fragment="mypage">
	<div id="mypageBody">
	<div id="myPointList">
		<span>로고</span>
		<span style="font-size:40px; color:black;">My 포인트</span>
		<strong> <span th:text="|${#numbers.formatInteger(mypoint, 0, 'COMMA')}|" style="font-size:40px; padding-left:30px; color:black;"></span></strong>
		<span style="font-size:30px; color:black;"> point</span>
		<a href="pointChargeForm" id="chargeBtn" >충전</a><br>
	</div>
	<div id="myCouponList">
		<span>로고</span>
		<span style="font-size:40px; color:black;">My 쿠폰</span>
		<strong> <span th:text="${#lists.size(mycoupon)}" style="font-size:40px; padding-left:70px; color:black;"></span></strong>
		<span style="font-size:30px; color:black;"> 개</span>
	</div>
	<div id="myPointTblDiv">
		<h4>포인트 적립 | 사용 내역</h4>
		<input type="date" id="startDate">
		<input type="date" id="endDate">
		<select id="dealSel">
    <option value="">전체거래</option>
    <option value="매도">매도</option>
    <option value="매수">매수</option>
    <option value="충전">충전</option>
    <option value="포인트몰">포인트몰</option>
</select>
<table id="myPointTbl">
    <thead>
        <tr>
            <th>날짜</th>
            <th>구분</th>
            <th>종목or제품이름</th>
            <th>이용내역</th>
        </tr>
    </thead>
    <tbody id="dealbody">

    </tbody>
</table>
<div>
<nav aria-label="Page navigation example" class="d-flex justify-content-center">
	<ul class="pagination">
		<li class="page-item">
			<a class="page-link" id="firstpage" href="javascript:firstPage()" aria-label="Previous">
				<span aria-hidden="true">&laquo;</span>
			</a>
		</li>
		<li class="page-item">
			<a class="page-link" id="prevpage" href="javascript:prevPage()" aria-label="Previous">
				<span aria-hidden="true" style="visibility: hidden;">&lt;</span>
			</a>
		</li>
		<!-- 페이징버튼 들어갈 공간 -->
		    <li class="page-item">
				<a class="page-link" id="nextpage" href="javascript:nextPage()" aria-label="Next">
					<span aria-hidden="true" style="visibility: hidden;">&rt;</span>
				</a>
			</li>
		    <li class="page-item">
				<a class="page-link" id="lastpage" href="javascript:lastPage()" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
				</a>
			</li>
		</ul>
	</nav>
</div>
</div>
</div>

<script>
const membNo = "[[${session.loggedInMember.membNo}]]";
const dt = "[[${session.loggedInMember.joinDt}]]";

let tablename = "";
let targetPage = 1;
let startPage=1;
let endPage=20;
let totalCnt;

let startDate = dt;
let today = new Date();   
let year = today.getFullYear(); // 년도
let month = today.getMonth() + 1 <10 ? '0'+(today.getMonth() + 1) : today.getMonth() + 1;  // 월
let date = today.getDate() < 10 ? date = '0'+today.getDate() : today.getDate();  // 날짜

let endDate = year + '/' + month + '/' + date; 
$("#startDate").val(startDate);
$("#endDate").val(`${year}-${month}-${date}`);


dealList();
pageBtn();

// 거래내역 호출
function dealList() {
    $.ajax({
        url: "dealList",
        method: "POST",
        data: {
            "membNo": membNo,
            "tablename": tablename,
            "startDate" : startDate,
            "endDate" : endDate,
            "page" : targetPage
        },
        success: function (data) {
            let tr = ''; // 각 호출마다 tr을 초기화
            console.log(data);
            data.forEach(el => {
            	console.log(el)
            let point = commas(el.point);
            	let orderDt = new Date(el.orderDt);
            	let formattedDt = `${orderDt.getFullYear()}-${(orderDt.getMonth() + 1).toString().padStart(2, '0')}-${orderDt.getDate().toString().padStart(2, '0')}`;
                tr += `
                        <tr>
                            <td>${formattedDt}</td>
                            <td>${el.tablename}</td>`;
                if (el.nm == null) {
                    tr += `<td>적립</td>`;
                } else {
                    tr += `<td>${el.nm}</td>`;
                }
                tr += `
                            <td class="point">${point}</td>
                        </tr>
                `;
                
                 if(el.point >=0){
                	$(".point").addClass("high");
                 } else{
                	 $(".point").addClass("low");
                 }
                 
            });
            $("#dealbody").append(tr);
        },
        error: function (err) {
            console.log(err);
        }
    });
	}

	$("#dealSel").on("change", function () {
	    $("#dealbody").html(""); // select가 변경되면 이전에 출력한 내용 초기화
	    tablename = $("#dealSel option:selected").val();
	    startDate = $("#startDate").val();
	    endDate = $("#endDate").val();
	    dealList();
	    pageBtn();

	});
	
 function pageBtn() {
	    $.ajax({
	        url: "getDealCount",
	        method: "POST",
	        data: {
	            "membNo": membNo,
	            "tablename": tablename,
	            "startDate": startDate,
	            "endDate": endDate
	        },
	        success: function (data) {
	            $('#nextpage').css('visibility', 'hidden');
	            $('#prevpage').css('visibility', 'hidden');
	            totalCnt = data;
	            endPage=~~((totalCnt-1)/20 + 1);
	            createPageCntBtn(startPage, endPage);
	            if(totalCnt>100){
	            	$('#nextpage').css('visibility', 'hidden');
		            $('#prevpage').css('visibility', 'hidden');
							}
	        },
	        error: function (err) {
	            console.log(err);
	        }
	       });
	   }
	   
	   //페이지 버튼생성
	   function createPageCntBtn(start,end){
	      $('.pagebtn').remove();
	      
	      for (let i = start; i <= end; i++) {
	        let liTag = $('<li></li>').addClass('page-item').addClass('pagebtn');
	        if (i % 20 === targetPage) {
	          liTag.addClass('active');
	        }
	        let aTag = $('<a></a>').addClass('page-li	nk').attr('href', 'javascript:pageMove(' + i + ');').text(i);
	        liTag.append(aTag);
	        $('#nextpage').before(liTag);
	      }
	   }
	   
	   //페이징 버튼클릭
	   function pageMove(page) {
		   $("#dealbody").html("");
		  $('.pagebtn.active').removeClass('active');
		  console.log(page);
		  targetPage = page;
		  dealList();
		  $('.pagebtn').each(function () {
		    if ($(this).children('a').text() == page) {
		      $(this).addClass('active');
		       }
		     });
	   }
	      
	   // 페이징 < 버튼 클릭
	   function prevPage() {
		   $("#dealbody").html("");
	     $('#nextpage').css('visibility', 'visible');
	     startPage -= 20;
	     endPage -= 20;
	     console.log(startPage)
	     if (startPage === 1) {
	       $('#prevpage').css('visibility', 'hidden');
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   // 페이징 > 버튼 클릭
	   function nextPage() {
		   $("#dealbody").html("");
	     $('#prevpage').css('visibility', 'visible');
	     startPage += 20;
	     endPage += 20;
	     if (endPage >= ~~((totalCnt - 1) / 20 + 1)) {
	       endPage = ~~((totalCnt - 1) / 20 + 1);
	       $('#nextpage').css('visibility', 'hidden');
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   function firstPage() {
		   $("#dealbody").html("");
	     startPage = 1;
	     if (endPage > 20) {
	       endPage = 20;
	     }
	     createPageCntBtn(startPage, endPage);
	     pageMove(startPage);
	   }
	   
	   function lastPage() {
		   $("#dealbody").html("");
	     if (endPage > 20) {
	       endPage = ~~((totalCnt - 1) / 20 + 1);
	     }
	     startPage = endPage - endPage % 20 + 1;
	     //console.log(startPage, endPage);
	     createPageCntBtn(startPage, endPage);
	     pageMove(endPage);
	   }

	
	 function commas(number) {
		  return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
		} 
</script>
</div>
</body>

</html>