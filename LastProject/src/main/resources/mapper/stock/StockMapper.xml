<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedam.app.stock.mapper.StockMapper">
	<!-- 카테고리 리스트 -->
	<select id="getThemeList" resultType="map">
		select common_cd , ctgr 
		from common_code
		where common_cd like #{code}||'%'
		<if test="code.length == 2">
			and length(common_cd) = 4
		</if>
		<if test="code.length == 4">
			and length(common_cd) = 6
		</if>
	</select>
	
	<!-- 종목정보 조회 -->
	<select id="getItemInfo" resultType="ItemVO">
	
		select * 
		from item 
		where 
		<if test='code.substring(0,1).equals("S")'>
		common_cd = #{value}
		</if>
		<if test='!code.substring(0,1).equals("S")'>
		nm = #{value}
		</if>
	</select>
	<!-- 자동완성 기능 -->
	<select id="autocomplete" parameterType="map" resultType="map">
		select ctgr ,common_cd
		from common_code
		where ctgr like '%'||#{value}||'%'
		and length(common_cd) =6
	</select>
	
	<!-- 자동완성 이용한 카테고리 종목정보 출력 -->
	<select id="autoInfo" resultType="map">
		select common_cd , h_cd 
		from common_code 
		where ctgr =(     
					  select h_ctgr
                      from common_code
                      where ctgr = #{value}
                      )
	</select>
	<!-- 모든종목조회 -->
	<select id="allItemList" resultType="StockVO">
		<![CDATA[
		select t.item_no, c.sc, c.theme, t.nm,t.prc tprc, t.prc - i.cl_prc change ,trunc(((t.prc-i.cl_prc)/i.cl_prc)*100) rate
		from (select item_no, cl_prc 
		      from item_info 
		      where to_char(ta_dt,'yyyy-MM-dd') = to_char(sysdate-1,'yyyy-MM-dd')
		      ) i 
		join ( SELECT nm,i.item_no, MAX(ta_dt) , ta_prc prc
		        FROM ta_hr t join item i 
		        on i.item_no = t.item_no
		        GROUP BY nm,i.item_no,ta_prc
		        order by item_no ) t  
		on i.item_no = t.item_no
		join (select case substr(common_cd,1,2) when 'S1' then '농산물'
		                                  when 'S2' then '수산물'
		                                  end sc
		                                  ,h_ctgr theme
		                                  , ctgr item
		from common_code
		where length(common_cd) =6
		order by common_cd ) c on c.item=t.nm
		]]>
	</select>
	<!-- 조회수 순위 및 전일비 및 변동률 -->
	<select id="inqChart" resultType="InqVO">
		<![CDATA[
			select rownum 
					,nm 
					, a.item_no
					,inq 
					, change 
					, rate 
			from (  select i.nm, i.item_no item_no , f.inq+i.inq inq
			        from item i join (  select item_no, sum(inq) inq
			                            from item_info 
			                            where ta_dt > sysdate-7 
			                            group by item_no
			                            order by inq desc) f
			        on i.item_no = f.item_no) a 
			join (  select i.item_no,i.cl_prc,t.prc tprc, t.prc - i.cl_prc change ,trunc(((t.prc-i.cl_prc)/i.cl_prc)*100) rate
			        from (select item_no, cl_prc 
			              from item_info 
			              where to_char(ta_dt,'yyyy-MM-dd') = to_char(sysdate-1,'yyyy-MM-dd')
			              ) i 
			        join ( SELECT nm,i.item_no, MAX(ta_dt) , ta_prc prc
			                FROM ta_hr t join item i 
			                on i.item_no = t.item_no
			                GROUP BY nm,i.item_no,ta_prc
			                order by item_no ) t  
			        on i.item_no = t.item_no) b 
			on a.item_no = b.item_no
			where rownum <6
			order by inq desc
		]]>
	</select>
	
</mapper>